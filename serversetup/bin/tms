#!/bin/bash
###############################################################################
#  tms â€” Tmux Session Manager
#  Interactive layout picker with fzf
###############################################################################

LAYOUTS_DIR="$HOME/.tmux-layouts"
BLUE='\033[0;34m'; CYAN='\033[0;36m'; GREEN='\033[0;32m'
YELLOW='\033[1;33m'; MAGENTA='\033[0;35m'; DIM='\033[2m'
BOLD='\033[1m'; NC='\033[0m'

# â”€â”€ Layout registry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
declare -A DESCRIPTIONS=(
    [dev]="Dev        â”‚ nvim + terminal + git sidebar"
    [cpp]="C++ Dev    â”‚ code or debug mode picker"
    [monitor]="Monitor    â”‚ btop + docker stats + logs"
    [media]="Media      â”‚ transmission + jellyfin logs + files"
    [admin]="Admin      â”‚ docker + caddy + fail2ban + ufw"
    [minimal]="Minimal    â”‚ clean session, single window"
)

declare -A ICONS=(
    [dev]="ðŸ› ï¸"
    [cpp]="âš™ï¸"
    [monitor]="ðŸ“Š"
    [media]="ðŸŽ¬"
    [admin]="ðŸ”§"
    [minimal]="ðŸ“‹"
)

LAYOUT_ORDER=(dev cpp monitor media admin minimal)

# â”€â”€ Attach or switch (handles nested tmux) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tmux_connect() {
    local target="$1"
    if [[ -n "${TMUX:-}" ]]; then
        tmux switch-client -t "$target"
    else
        tmux attach-session -t "$target"
    fi
}

# â”€â”€ Build fzf menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
run_picker() {
    local items=""

    for layout in "${LAYOUT_ORDER[@]}"; do
        if [[ -f "$LAYOUTS_DIR/$layout.sh" ]]; then
            items+="${layout}|${ICONS[$layout]}  ${DESCRIPTIONS[$layout]}"$'\n'
        fi
    done

    local active
    active=$(tmux list-sessions -F "#{session_name}" 2>/dev/null) || true
    if [[ -n "$active" ]]; then
        while IFS= read -r s; do
            items+="attach:${s}|ðŸ”—  Attach     â”‚ $s"$'\n'
        done <<< "$active"
    fi

    if [[ -n "$active" ]]; then
        items+="kill|ðŸ’€  Kill All   â”‚ destroy all tmux sessions"$'\n'
    fi

    local choice
    choice=$(echo -e "$items" | sed '/^$/d' | fzf \
        --ansi \
        --height=~20 \
        --border=rounded \
        --border-label="  tms â€” session picker  " \
        --prompt="  " \
        --pointer="â–¸" \
        --with-nth=2.. \
        --delimiter='|' \
        --header="$(tmux list-sessions -F '  active: #S' 2>/dev/null || echo '  no active sessions')" \
        --header-first \
        --preview="key=\$(echo {} | cut -d'|' -f1); \
            if [[ -f $LAYOUTS_DIR/\$key.sh ]]; then cat $LAYOUTS_DIR/\$key.sh; \
            elif [[ \$key == attach:* ]]; then tmux list-windows -t \${key#attach:} 2>/dev/null; \
            else echo \$key; fi" \
        --preview-window=right:50%:wrap \
        --color="fg:#a9b1d6,bg:#1a1b26,hl:#7aa2f7,fg+:#c0caf5,bg+:#283457,hl+:#7aa2f7,info:#e0af68,prompt:#7aa2f7,pointer:#9ece6a,marker:#9ece6a,spinner:#9ece6a,header:#565f89,border:#3b4261,label:#7aa2f7" \
    ) || exit 0

    local key
    key=$(echo "$choice" | cut -d'|' -f1)

    case "$key" in
        attach:*)
            local session_name="${key#attach:}"
            tmux_connect "$session_name"
            ;;
        kill)
            tmux kill-server 2>/dev/null
            echo -e "${GREEN}All sessions killed.${NC}"
            sleep 0.5
            run_picker
            ;;
        *)
            launch_layout "$key"
            ;;
    esac
}

# â”€â”€ Launch a layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
launch_layout() {
    local layout_name="$1"
    local layout_file="$LAYOUTS_DIR/$layout_name.sh"

    if [[ ! -f "$layout_file" ]]; then
        echo "Layout not found: $layout_name"
        return 1
    fi

    # Check if this is a dynamic session layout (always run fresh)
    local is_dynamic=false
    if grep -q 'DYNAMIC_SESSION' "$layout_file"; then
        is_dynamic=true
    fi

    if [[ "$is_dynamic" == true ]]; then
        # Dynamic layout: always run the script, capture session name
        echo -e "${GREEN}Launching $layout_name...${NC}"
        local output
        output=$(bash "$layout_file")
        local session_name
        session_name=$(echo "$output" | grep '^DYNAMIC_SESSION=' | cut -d'=' -f2)
        session_name="${session_name:-$layout_name}"
        tmux_connect "$session_name"
    else
        # Static layout: check for existing session
        local session_name
        session_name=$(grep '^SESSION=' "$layout_file" | head -1 | cut -d'"' -f2)
        session_name="${session_name:-$layout_name}"

        if tmux has-session -t "$session_name" 2>/dev/null; then
            echo -e "${YELLOW}Session '$session_name' already exists â€” connecting.${NC}"
            sleep 0.3
            tmux_connect "$session_name"
            return
        fi

        local work_dir="$HOME"
        if [[ "$layout_name" == "dev" ]]; then
            echo -e "${CYAN}Working directory:${NC} (Enter for ~)"
            read -rp "  > " input_dir
            [[ -n "$input_dir" ]] && work_dir="$input_dir"
        fi

        echo -e "${GREEN}Launching $layout_name...${NC}"
        bash "$layout_file" "$work_dir"
        tmux_connect "$session_name"
    fi
}

# â”€â”€ CLI interface â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
case "${1:-}" in
    -l|--list)
        echo -e "${BOLD}Available layouts:${NC}"
        for layout in "${LAYOUT_ORDER[@]}"; do
            echo -e "  ${GREEN}â–¸${NC} ${ICONS[$layout]}  ${DESCRIPTIONS[$layout]}"
        done
        exit 0
        ;;
    -k|--kill)
        tmux kill-server 2>/dev/null && echo "All sessions killed." || echo "No sessions."
        exit 0
        ;;
    -a|--attach)
        tmux_connect "${2:-}" 2>/dev/null || echo "Session not found."
        exit 0
        ;;
    -h|--help)
        echo -e "${BOLD}tms${NC} â€” Tmux Session Manager"
        echo ""
        echo "Usage:"
        echo "  tms              Interactive picker"
        echo "  tms <layout>     Launch layout directly (dev, cpp, monitor, media, admin, minimal)"
        echo "  tms -l           List layouts"
        echo "  tms -k           Kill all sessions"
        echo "  tms -a <n>    Attach to session"
        echo "  tms -h           This help"
        exit 0
        ;;
    "")
        run_picker
        ;;
    *)
        if [[ -f "$LAYOUTS_DIR/$1.sh" ]]; then
            launch_layout "$1"
        else
            echo "Unknown layout: $1"
            echo "Available: $(ls "$LAYOUTS_DIR"/*.sh 2>/dev/null | xargs -I{} basename {} .sh | tr '\n' ' ')"
            exit 1
        fi
        ;;
esac